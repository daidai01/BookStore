# Bookstore设计文档

###### written by daidai01

## 文件存储

#### 4个数据存储文件

```c++
basic.dat //存储基本数据：图书总数、用户总数、总支出、总收入、交易总次数
user.dat //存储用户信息
book.dat //存储图书信息
log.dat //存储登录信息
```

#### 5个索引文件（由块状链表维护）

```c++
userID.dat //按用户ID排序
bookISBN.dat //按图书ISBN排序
bookAuthor.dat //按图书作者排序
bookName.dat //按图书名称排序
bookKeyword.dat //按图书关键词排序
```

## 代码

* ### main.cpp

  * 将指令按行读入
  * 捕获异常，并输出异常信息

* ### blocklist.h/blocklist.cpp

  由3个类组成，实现一个块状链表，用于文件索引
  
  * Element类
  ```c++
    int offset = -1;
    char key[61] = {0};

    bool operator<(const Element &o) const; //重载'<'，按关键词key排序
  ```
  
  * Block类
  ```c++
    int pre = -1; //链表中前一block的offset
    int nxt = -1; //链表中后一block的offset
    int len = 0; //block中element的个数
    Element block[500];
  ```
  
  * BlockList类
  ```c++
  private:
    string fileName;
    fstream in, out, nextIn;

  private:
    int nextBlock(int offset); //返回地址为offset的block的后一block的地址
    void splitBlock(int offset); //将block分成两块，其中一块添加在文件末尾
    void mergeBlock(int offset1, int offset2); //将两个block合并，
    void deleteBlock(int offset);

  public:
    BlockList();
    explicit BlockList(const string &_fileName);
    void findElement(const char *key, vector<int> &array);
    void addElement(const Element &o);
    void deleteElement(const Element &o);
